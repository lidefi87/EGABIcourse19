# Mapeo

## Mapas en `R`

El paquete [`rnaturalerath`](https://cran.r-project.org/web/packages/rnaturalearth/vignettes/rnaturalearth.html) contiene un conjunto de datos de tipo vector con información del mundo, incluyendo un mapa del mundo con límite de países y líneas costeras.
  
```{r wrld-simpl}
library(sf)
library(rnaturalearth)
library(ggplot2)

#Cargando datos del mundo
world <- ne_countries(returnclass = "sf") 

#Graficando en un mapa
world |> 
  ggplot()+
  geom_sf()+
  theme_bw()
```

Este conjunto de datos se alinea exactamente con la extensión convencional de -180/180 -90/90 para la proyección de longitud/latitud.

```{r lon180-lat90}
ggplot()+
  geom_sf(data = world)+
  geom_rect(aes(xmin = -180, xmax = 180, ymin = -90, ymax = 90),
            fill = NA, colour = "red", linewidth = 1)+
  theme_bw()
```

### Ejercicios

1. ¿Cómo podemos encontrar los rangos de longitud y latitud de los datos de mapas `m` y los datos del mundo de `rnaturalearth`? 
2. ¿Podemos dibujar polígonos con un color de relleno con el paquete? 


Respuesta 1: `st_bbox(world)` nos dará los límites del vector.  

Respuesta 2: Podemos usar `rnaturalearth` en conjunto con `ggplot2` así: `ggplot(world)+geom_sf(fill = "gray")`
  
### ¡Usemos los datos de mapas!

Intentemos crear un mapa con proyección estereográfica usando `rnaturalearth`. Los límites que usaremos en el mapa se pueden encontrar [aquí](https://epsg.io/3976).  
  
```{r}
world_reproj <- world |> 
  #Aplicamos una transformacion al shapefile original
  st_transform(3976) 

world_reproj|> 
  #Graficamos
  ggplot()+
  geom_sf()+
  #Centramos el mapa en la Antartida
  lims(x = c(-3289335.29, 3289335.29),
       y = c(-3323160.27, 3323160.27))+
  theme_bw()
```
  
#### Agregando puntos al mapa
Supongamos que tengamos puntos donde hemos hecho mediciones de algún tipo. Podemos incluir estos puntos en un mapa de la siguiente manera.  
  
```{r somap_pts1}
## algunos datos de longitud/latitud
my_points_ll <- data.frame(lon = seq(0, 350, by = 10), 
                           lat = -55, z = runif(36))

# transformamos en un shapefile
my_points_ll <- my_points_ll |> 
  st_as_sf(coords = c("lon", "lat"), crs = 4326)
```

Nuestros datos deben reproyectarse para que coincidan con nuestro mapa antes de trazarlos.

```{r somap_pts2}
## reproyectamos los puntos 
my_points <- st_transform(my_points_ll, crs = crs(world_reproj))

## ahora creamos el mapa
ggplot()+
  geom_sf(data = world_reproj)+
  geom_sf(data = my_points, colour = "blue")+
  lims(x = c(-4289335.29, 4289335.29),
       y = c(-4323160.27, 4323160.27))+
  theme_bw()
```

  
#### Agregar capas tipo raster

Primero construyamos algunos datos raster artificiales (en espacio de longitud-latitud) con fines de demostración:

```{r somap_raster1, message = FALSE, warning = FALSE}
# libreria para rasters
library(terra)

# creamos datos de temperatura
# primero creamos una grilla
temp <- as.data.frame(expand.grid(lon = seq(100, 140, by = 0.25),
                                  lat = seq(-65, -45, by = 0.1)))
#Luego creamos temperaturas
temp$val <- sqrt((temp$lon - 120)^2/3 + (temp$lat - -40)^2/5)

# creando objeto raster
xr <- rast(temp, type = "xyz", crs = "epsg:4326")

# finalmenete reproyectamos al mismo CRS del mapa del mundo
xr_proj <- terra::project(xr, crs(world_reproj))
```

`SOplot` reproyecta esto por nosotros:

```{r somap_raster2}
ggplot()+
  #graficamos al mundo
  geom_sf(data = world_reproj)+
  #graficamos a los datos de temperatura que creamos
  geom_spatraster(data = xr_proj, aes(fill = val))+
  #nos centramos en la Antartida
  lims(x = c(-5289335.29, 5289335.29),
       y = c(-5323160.27, 5323160.27))+
  #cambiamos la paleta de colores
  scale_fill_viridis_c(na.value = NA)+
  theme_bw()
```


Alternativamente, podríamos establecer explícitamente el rango de colores y las etiquetas.
```{r somap_raster4}
## dibuja mapa base
SOmap()
## agregar nuestro raster, controlando el rango de colores para abarcar los valores de 0 a 30
colour_breaks <- seq(0, 30, length.out = length(my_cmap) + 1)
SOplot(xr, legend = FALSE, col = my_cmap, breaks = colour_breaks)
## agregar la leyenda, controlando nuevamente el rango de colores
label_breaks <- seq(0, 30, length.out = 7)
SOleg(position = "topright", col = my_cmap, breaks = label_breaks,
      type = "continuous", label = "My variable")
```

Agregando múltiple rasters:  

```{r somap_raster5}
xr2 <- shift(xr, -70) ## agrega desplazamiento en longitud

ggplot()+
  #graficamos al mundo
  geom_sf(data = world_reproj)+
  #graficamos a los datos de temperatura que creamos
  geom_spatraster(data = xr_proj, aes(fill = val))+
  #graficamos los datos nuevos
  geom_spatraster(data = xr2, aes(fill = val))+
  #nos centramos en la Antartida
  lims(x = c(-5289335.29, 5289335.29),
       y = c(-5323160.27, 5323160.27))+
  #cambiamos la paleta de colores
  scale_fill_viridis_c(na.value = NA)+
  theme_bw()
```

## Datos de soporte para crear mapas

Cuando se construyen mapas, comúnmente queremos mostrar características como frentes oceanográficos, extensión de hielo, línea de costa, nombres de lugares y límites de AMP (Áreas Marinas Protegidas). Hay algunas fuentes de estos datos:

- algunas capas están incluidas en `SOmap`, consultar objeto `SOmap::SOmap_data`
- `antanym` proporciona acceso al Gazetteer Compuesto de la SCAR (Comité Científico de Investigación Antártica) de nombres de lugares
- El paquete`quantarcticR` provee acceso a las capas de datos de [Quantarctica](http://quantarctica.npolar.no/)
