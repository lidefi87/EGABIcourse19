# Introducción a `R` y a `Tidyverse`

[Presentation (PDF)](./course_material/tidyverse/Tidyverse.pdf)

## Ejercicio `R` script

El script se puede descargar en el siguiente link [downloaded here](./course_material/tidyverse/Intro_to_tidyverse.R) y también esta copiado abajo.  
  
```{r eval = FALSE}

## Aquí cargamos el tidyverse. Tidyverse incluye múltiples paquetes que pueden trabajar juntos. 
## Si lo cargamos directamente como lo hacemos aquí, nos arroja una tabla identificando todos los paquetes que están adjuntos. 
library(tidyverse)
## también se puede ver una lista de funciones que arrojan conflictos - ver nombres de funciones que aparecen bajo múltiples paquetes
## Por ejemplo, Hay una función "filter" (filtro) repetida en los paquetes 'stats'
## y en 'dplyr'. Mira las notas del curso sobre los prefijos de espacio de nombres (por 
## ejemplo, los usos de "dplyr::filter()" a continuación).

## Carguemos el conjunto de datos (dataset) 'starwars' que se encuentra en el paquete dplyr (lo usaremos más adelante)
data(starwars)


#################################################################
#### Importación de datos ####
########################

setwd("c:/EGABIcourse19-master/docs/course_material/tidyverse")

## Usando la función read.csv de R base, las clases de las columnas se importan de manera 
## deficiente y tendríamos que convertirlas manualmente más tarde.
X.csv <- read.csv('tidyverse_dummy_import.csv')
sapply(X.csv, class)


## La biblioteca readr puede leer archivos CSV de mejor manera y las columnas se pueden 
## definir mejor.
X.csv_r <- readr::read_csv('tidyverse_dummy_import.csv',
                           col_types=list(Occurrence_field = col_factor()))

## La biblioteca readxl se utiliza para leer otros formatos de Excel y funciona bien para 
## columnas de fecha y hora
## Sin embargo, no tiene una opción de tipo de columna para factores
## (si quisieras definir una columna como factor)
X.xlsx_t <- readxl::read_xlsx('tidyverse_dummy_import.xlsx',1,
                              col_types = c('guess','numeric','numeric','text','date'))
## si necesitaras convertir una columna a factor puedes usar:
X.xlsx_t$Occurrence_field <- as.factor(X.xlsx_t$Occurrence_field)


###################################################################
#### Manipulación de datos ####
########################

# selecciona las columnas name (nombre), gender (género) y homeworld (mundo de origen)
starwars %>% dplyr::select(name,gender,homeworld)
## Ten en cuenta que usamos dplyr::select() en lugar de select() porque hay varias funciones 
## "select" en diferentes paquetes.
## Usar el nombre del paquete como prefijo hace que sea claro cuál función y de qué paquete estamos usando y reduce la 
## posibilidad de errores causados por paquetes que se cargan en un orden diferente.


# Equivalente en R base
starwars[,c('name','gender','homeworld')]


# Filtra las columnas con personajes de Tatooine
starwars %>% dplyr::filter(homeworld=='Tatooine')
# Equivalente en R base
starwars[which(starwars$homeworld=='Tatooine'),]


# Encadenamiento "stringing" de argumentos
starwars %>%
  dplyr::select(name,gender,homeworld)%>%
  dplyr::filter(homeworld=='Tatooine')

# Equivalente en R base
starwars[which(starwars$homeworld=='Tatooine'),c('name','gender','homeworld')]


##################################
#### Agrupamiento y resumen ####
##################################
starwars %>% group_by(homeworld)

## Esto obtiene la altura promedio de los personajes, agrupados por homeworld, y agrega un 
## recuento para obtener el tamaño de la muestra.
starwars %>%
  group_by(homeworld) %>%
  summarise(mean_height = mean(height),n = n())


## Esto obtiene la altura promedio de los personajes, agrupados por homeworld, y agrega un 
## recuento para obtener el tamaño de la muestra.
starwars %>%
  group_by(homeworld,gender) %>%
  summarise(mean_height = mean(height),n = n()) %>%
  dplyr::filter(!is.na(homeworld))


### Otras formas de contar
starwars %>% count(homeworld,gender) %>% dplyr::filter(!is.na(homeworld))
starwars %>% add_count(homeworld,gender) %>% dplyr::filter(!is.na(homeworld))

################
#### TAREAS ####

##  Crea una tabla con la media, mediana y desviación estándar de la masa para todos los humanos con cabello marrón.
starwars %>%
  group_by(hair_color,species) %>%
  summarise(meanmass=mean(mass,na.rm = T),
            medmass=median(mass,na.rm = T),
            sdmass=sd(mass,na.rm = T)) %>%
  dplyr::filter(species == 'Human',hair_color=='brown')

## Obtén al personaje no humano más alto y el más bajo.
starwars %>%
  dplyr::filter(species != 'Human') %>%
  arrange(height)

starwars %>%
  dplyr::filter(species != 'Human') %>%
  arrange(-height)

## ¿Cuántos droides aparecieron en "Attack of the Clones"?
starwars %>%
  unnest(films) %>%
  count(species,films) %>%
  dplyr::filter(species=='Droid',films=='Attack of the Clones')


######################################
#### Mutaciones ####

# Esto calculará una nueva columna con la relación entre la altura y la masa. (height:mass)
starwars %>%
  mutate(hm_ratio = height/mass)


######################################
#### Uniones ####

df1 <- tibble(
  category = c('a','a','b','c','c','a','b'),
  id = c(1,2,3,4,5,6,7)
)

df2 <- tibble(
  category = c('b','a','b','a','a','c','c'),
  id = c(7,6,5,4,3,2,1)
)

## Esto unirá las dos tablas tibble por el valor de id.
df1 %>% left_join(df2,by='id')



#################################################################
#### Reunir y Extender ####
###########################

### Este es un conjunto de datos en el que podrás encontrar: 
### diferentes dispositivos que toman medidas en el mismo día
sst_data <- data.frame(
  time = as.Date('2009-01-01') + 0:9,
  unit_A = round(runif(10, 6, 9),2),
  unit_B = round(runif(10, 7, 10),2),
  unit_C = round(runif(10, 6, 10),2)
)

## "pivot_longer" hace que el marco de datos pase de un formato ANCHO (WIDE) a LARGO (LONG) 
## (el formato LARGO suele ser utilizado por ggplot2).

sst_data %>%
  pivot_longer(!time, names_to = "unit", values_to = "sst")

## "pivot_wider" es la función opuesta a "pivot_longer" y cambia el formato de LARGO a ANCHO
sst_data %>%
  pivot_longer(!time, names_to = "unit", values_to = "sst") %>%
  pivot_wider(names_from = "unit", values_from = "sst")


###############################
#### Anidaciones ####

## Esto anida las columnas unit y sst en una tabla para cada columna de tiempo.
nested_sst <- sst_data %>%
  pivot_longer(!time, names_to = "unit", values_to = "sst") %>%
  nest_by(time)

## Esto se puede usar para ver una tabla de datos en específico
nested_sst$data[[1]]

###############################
#### Tarea 2 ####
#################################

## Un tibble con películas de Star Wars clasificadas según mi preferencia
film.rankings <- tibble(
  films = c('The Phantom Menace','Attack of the Clones','Revenge of the Sith',
           'A New Hope','The Empire Strikes Back','Return of the Jedi',
           'The Force Awakens'),
  rank = c(7,6,5,3,4,1,2)
)


## ¿En qué películas aparece el personaje Plo Koon, ordenadas por clasificación? 
## El resultado final
##  debe ser una única tabla obtenida de una columna
Plo.Koon <-starwars %>%
  dplyr::select(name,films) %>%
  unnest(films) %>%
  left_join(film.rankings,by='films') %>%
  arrange(name,rank) %>%
  nest(films,rank) %>%
  dplyr::filter(name == 'Plo Koon')



## Crea una tabla que anide los datos de altura y masa solo para humanos en una 
## columna anidada por el nombre de la película.
nested.mass.height <- starwars %>%
  unnest(films)%>%
  dplyr::select(name,height,mass,films,species) %>%
  dplyr::filter(species=='Human')%>%
  nest(name,height,mass)




################################################################################
#### Tarea final - programación funcional

## Crea un objeto que sea una lista de vectores
X <- c(list(seq(1,50,5)),list(seq(40,100,2)))

## R base
lapply(X,mean)

## tidyverse
map(X,mean)



### Esto muestra cómo puedes usar map para ejecutar funciones en listas y obtener 
### resultados de modelos interesantes para matrices de datos grandes. 
### Muy útil para resumir datos rápidamente

library(dplyr)
library(purrr)
library(broom)

nested.mass.height %>%
  mutate(
    model = map(
      data,~lm(mass~height,data=.x)
    ),
    slope = map_dbl(
      model, ~coef(.x)['height']
    ),
    r.sq = map_dbl(
      model,~glance(.x)$'r.squared'
    ),
    sample_size = map_dbl(
      data,~nrow(.x)
    ),
    tallest = map(
      data,~.x[which.max(.x$height),'name']
    ),
    heaviest = map(
      data,~.x[which.max(.x$mass),'name']
    )
  ) %>%
  unnest(tallest,heaviest) %>%
  rename(tallest=name,heaviest=name1)

#########################################################################
#### ggplot2 link ####
starwars %>%
  dplyr::filter(species=='Human',gender=='male') %>%
  ggplot(aes(x=mass,y=height))+
    geom_point()+
    geom_smooth(method=lm)
```


## Ver tambien

- [Introducción a `R` y RStudio de Software Carpentry](https://swcarpentry.github.io/r-novice-gapminder-es/01-rstudio-intro.html).
- [Introducción a `R` (en inglés)](https://obis.org/manual/intror/) por el Sistema de Información Biogeográficos de los Océanos (OBIS por sus siglas en inglés).
- [`R` para Ciencia de Datos](https://es.r4ds.hadley.nz/).

